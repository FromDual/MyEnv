#!/bin/bash
# preinst script for myenv
#
# see: dh_installdeb(1)

set +e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

MYSQL_GROUP=mysql
MYSQL_USER=mysql
MYSQL_HOME=/home/mysql

function create_user ()
{
# Create a MySQL user and group, for "myenv" now and the MySQL daemon later.
# If group 'mysql' exists, just use it.
# If user 'mysql' exists, ensure HOME = '/home/mysql' and SHELL = '/bin/bash'.
getent group ${MYSQL_GROUP} >/dev/null || groupadd -r ${MYSQL_GROUP} 2>/dev/null
USERLINE=$(getent passwd ${MYSQL_USER})
if [ -z "$USERLINE" ] ; then
    # No such user - create it from scratch
    useradd -m -N -r -d ${MYSQL_HOME} -s /bin/bash -c "MySQL server" \
        -g ${MYSQL_GROUP} ${MYSQL_USER} 2>/dev/null
else
    REGEX=".*:([^:]*):([^:]*)$"
    if [[ $USERLINE =~ $REGEX ]] ; then
        OLD_HOMEDIR=${BASH_REMATCH[1]}
        OLD_SHELL=${BASH_REMATCH[2]}
    else
        echo "User 'mysql' exists, but analyzing its settings fails - ABORT"
        exit 1
    fi
    usermod -g ${MYSQL_GROUP} ${MYSQL_USER} 2>/dev/null
    if [ -z "$OLD_SHELL" -o "$OLD_SHELL" = "/bin/false" -o "$OLD_SHELL" = "/usr/sbin/nologin" ] ; then
        usermod -s /bin/bash ${MYSQL_USER}
    fi
    if [ "$OLD_HOMEDIR" = "${MYSQL_HOME}" ] ; then
        :
    else
        PROCS=$(ps --no-headers -fu ${MYSQL_USER})
        if [ -n "$PROCS" ] ; then
            echo "User '${MYSQL_USER}' has running processes, cannot change '$HOME' - ABORT"
            exit 1
        fi
        usermod -d ${MYSQL_HOME} ${MYSQL_USER}
    fi
    mkdir ${MYSQL_HOME} 2>/dev/null || :
    SKEL=/etc/skel
    eval $(grep '^SKEL=' /etc/default/useradd)
    for F in .bashrc .bash_profile .bash_logout .profile
    do
        if [ -f ${SKEL}/${F} -a ! -f ${MYSQL_HOME}/${F} ] ; then
            cp ${SKEL}/${F} ${MYSQL_HOME}
        fi
    done
    chown -R ${MYSQL_USER}: ${MYSQL_HOME}
fi
}

case "$1" in
    install|upgrade)
        create_user
    ;;

    abort-upgrade)
        : # no action
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# There is no 'preinst.dehelper' in Ubuntu 14.04 or 16.04 LTS (Trusty or Cenial)

exit 0
